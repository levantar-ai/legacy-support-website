name: Generate Infographic PDFs

on:
  push:
    branches:
      - main
    paths:
      - 'infographics/**'
  workflow_dispatch:

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Generate PDFs
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');
          const path = require('path');

          async function generatePDFs() {
            const infographicsDir = './infographics';
            const outputDir = './infographics/pdf';

            // Create output directory
            if (!fs.existsSync(outputDir)) {
              fs.mkdirSync(outputDir, { recursive: true });
            }

            // Get all HTML files
            const files = fs.readdirSync(infographicsDir).filter(f => f.endsWith('.html'));

            const browser = await chromium.launch();

            for (const file of files) {
              const htmlPath = path.join(infographicsDir, file);
              const pdfName = file.replace('.html', '.pdf');
              const pdfPath = path.join(outputDir, pdfName);

              console.log(`Generating ${pdfName}...`);

              const page = await browser.newPage();

              // Read the HTML file to determine orientation
              const htmlContent = fs.readFileSync(htmlPath, 'utf8');
              const isLandscape = htmlContent.includes('A3 landscape');

              // Load the HTML file
              await page.goto(`file://${path.resolve(htmlPath)}`, {
                waitUntil: 'networkidle'
              });

              // Wait for fonts to load
              await page.waitForFunction(() => document.fonts.ready);

              // Generate PDF with A3 size
              await page.pdf({
                path: pdfPath,
                format: 'A3',
                landscape: isLandscape,
                printBackground: true,
                margin: { top: 0, right: 0, bottom: 0, left: 0 }
              });

              await page.close();
              console.log(`Generated ${pdfPath}`);
            }

            await browser.close();
            console.log('All PDFs generated successfully!');
          }

          generatePDFs().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: List generated PDFs
        run: ls -la infographics/pdf/

      - name: Upload PDFs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infographic-pdfs
          path: infographics/pdf/*.pdf
          retention-days: 90

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        id: semantic
        with:
          extra_plugins: |
            @semantic-release/git
            @semantic-release/changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload PDFs to Release
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.semantic.outputs.new_release_version }}
          files: infographics/pdf/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
